{"version":3,"file":"hapiness-mongo-adapter.js","sourceRoot":"","sources":["../../../../src/module/adapters/hapiness-mongo-adapter.ts"],"names":[],"mappings":"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","sourcesContent":["import { ModelManager } from '../managers/model-manager';\nimport { EventEmitter } from 'events';\nimport { Observable } from 'rxjs/Observable';\nimport { HapinessMongoAdapterConstructorArgs } from './interfaces';\nimport { UtilFunctions, Debugger } from '../shared';\n\nconst __debugger = new Debugger('HapinessMongoAdapter');\n\n/*\n * Not really abstract but we'll simulate it\n */\nexport class HapinessMongoAdapter extends EventEmitter {\n    protected _config: HapinessMongoAdapterConstructorArgs;\n    protected _uri: string;\n    protected _isReady: boolean;\n\n    protected _connection: any;\n    protected _db: any;\n\n    protected _modelManager: ModelManager;\n\n    public static getInterfaceName(): string {\n        throw new Error('Your adapter should implements `getInterfaceName()`');\n    }\n\n    constructor(options: HapinessMongoAdapterConstructorArgs) {\n        super();\n\n        this._config = options;\n\n        // It means we're not on test environment but we dont get any config!\n        if (!this._config || !Object.keys(this._config).length) {\n            throw new Error('Missing mongodb configuration');\n        }\n\n        this._isReady = false;\n\n        if (options.skip_connect) {\n            return;\n        }\n\n        this._modelManager = new ModelManager();\n\n        this\n            .connect()\n            .subscribe(_ => {\n                __debugger.debug('constructor', 'OK');\n            }, (err) => {\n                __debugger.debug('constructor', `Err catched :: ${err.message}`);\n                __debugger.debug('constructor', `Err catched :: ${JSON.stringify(err, null, 2)}`);\n            });\n    }\n\n    public connect(): Observable<void> {\n        this._connection = null;\n\n        const db = this._config.db || this._config.database;\n\n        if (this._config.url) {\n            this._uri = UtilFunctions.getMongoUri(this._config.url, db);\n        } else if (!!db) {\n            this._uri = `mongodb://${this._config.host}:${this._config.port || 27017}/${db}`;\n        } else {\n            return Observable.throw(new Error('No db name nor url provided'));\n        }\n\n        return this.tryConnect();\n    }\n\n    public tryConnect(): Observable<void> {\n        return this\n            ._tryConnect()\n            .switchMap(_ => this._afterConnect());\n    }\n\n    /*\n     *\n     *  This function should be overriden by all inherited classes.\n     *\n     */\n    protected _tryConnect(): Observable<void> {\n        return Observable\n            .throw(new Error('`_tryConnect` is not implemented'));\n    }\n\n    /*\n     *\n     *  This function should be overriden by all inherited classes.\n     *\n     */\n    protected _afterConnect(): Observable<void> {\n        return Observable\n            .throw(new Error('`_afterConnect` is not implemented'));\n    }\n\n    /*\n     *\n     *  This function should be overriden by all inherited classes.\n     *\n     */\n    public getLibrary(): any {\n        throw new Error('`getLibrary` is not implemented');\n    }\n\n    /*\n     *\n     *  This function should be overriden by all inherited classes.\n     *\n     */\n    public registerValue(schema: any, collection: string): any {\n        throw new Error('`registerValue` is not implemented');\n    }\n\n    public getModelManager(): ModelManager {\n        return this._modelManager;\n    }\n\n    protected onConnected(): Observable<void> {\n        __debugger.debug('onConnected', '');\n\n        return Observable\n            .create(observer => {\n                this._isReady = true;\n                this.emit('ready');\n\n                observer.next();\n                observer.complete();\n            });\n    }\n\n    protected onDisconnected(): Observable<void> {\n        __debugger.debug('onDisconnected', '');\n\n        this.emit('disconnected');\n\n        return this\n            .tryConnect()\n            .delay(5000);\n    }\n\n    protected onError(err?: any): Observable<void> {\n        __debugger.debug('onError', `got error :: ${JSON.stringify(err, null, 2)}`);\n\n        return this\n            .tryConnect()\n            .delay(5000);\n    }\n\n    public whenReady(options: { timeout: number } = { timeout: 60000 }): Observable<void> {\n        return Observable\n            .create(observer => {\n                if (this._isReady) {\n                    __debugger.debug('whenReady', 'already ready');\n\n                    observer.next();\n                    observer.complete();\n                    return;\n                }\n\n                this.once('ready', () => {\n                    __debugger.debug('whenReady', 'now ready');\n\n                    this._isReady = true;\n\n                    observer.next();\n                    observer.complete();\n                });\n            })\n            .timeout(options.timeout);\n    }\n\n    public isConnected(): boolean {\n        return this.isReady();\n    }\n\n    public isReady(): boolean {\n        return this._isReady;\n    }\n\n    public getUri(): string {\n        return this._uri;\n    }\n\n    public getConnection(): any {\n        return this._connection;\n    }\n\n}\n"]}